pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
frame_count = 0
-- level runner
beat_total = 0
lb=0
sx = 0 --debug
sy = 0 --debug
--delta + smoothing
delta = 0
delta_chunk = {}
delta_chunk_size = 15 --moving average of last 15 frames

function beat()
	return stat(50)
end

state = "idle"
song_name = ""
attempts = -1
timeline = nil
musid = 0

function run_level(name, deaths, tl, mus, tempo)
 state = "printing"
 timeline = tl
 musid = mus
 song_name = name
 attempts = deaths
 speed = tempo
 current = {}
 beat_total = -1
 lb = 0
 last_run = -1
end

function bullet(time_passed)
	circfill(time_passed/5, time_passed/3, 5, 14)
end

function _init()
	run_level("test", 10, {[4]={{f=bullet,d=5}}}, 0, 20)
end

function _update60()
	frame_count += 1
end

function avg(nums)
	local sum = 0
	for num in all(nums) do
		sum += num
	end
	return sum/#nums
end

function _draw()
 cls()
 local delta_current = (stat(56)%speed)/speed -- time passed since last frame (in beat time)
 if delta_current >= beat_total%1 then delta_current -= beat_total%1
 else delta_current = (1-beat_total%1) + delta_current end
 --now for delta smoothing
 if #delta_chunk >= delta_chunk_size then
  del(delta_chunk, delta_chunk[0])
 end
 add(delta_chunk, delta_current)
 delta = avg(delta_chunk)
 delta = flr(delta*100)/100 --round to nearest hundreds place for extra smoothness
 beat_total += delta_current
 print(delta_current, 9)
 print(delta, 7)
 print(beat_total, 6)
 sx += delta*5
 sy += delta*5
 rectfill(sx, sy, sx+20, sy+20, 7)
	if state == "printing" then
	 music(musid)
		state = "level"
	elseif state == "level" then
		-- if we haven't looked for new funcitons yet
		if last_run < flr(beat_total) then
		 elements = timeline[flr(beat_total)]
		 if not (elements == nil) then
		 	for element in all(elements) do
		 		add(current, element)
				end
   end
		 last_run = flr(beat_total)
		end
		for element in all(current) do
			print(element.d)
		end
	end
end
__sfx__
49020800101510e1510c051070510205100051000510005115000110000c100071000210000100001000010000000000000000000000000000000000000000000000000000000000000000000000000000000000
49040a0003673286601c6501c6401c6331c6000430002300003000030000300003000030000300013000130001300013000130001300013000130000300003000030000300003000030000000000000000000000
11041b0012870166701566014660136511265011640106400f6400e6400c64017630176311763017620176201262011620106100f6100e6100c61010200102001120011200122001320000000000000000000000
611400001024013242152421724010240132401524017240102400e2400b24007240102550e2500b2520725010240132421524217241122401324215240182401c2411a240172401a240282502b2552825526250
611400001c2401f24221242232401c2401f240212402324024240232401f2401d240242551f2501d2521c2501c2401f24221242232411c2401f2422124122241282452d24123241282421f2421f2551f2651f275
1114000010240102401024010231102401024010240102430f24512245122450f2400f2350f2450f2420f2421024210242102401024010200102421024010240112401124010241102420f2400e2410c2410b241
591400001c2501c2501c2501c2411c2501c2501c2501c2531b2551b2551b2551b250222451b2551b2521b2551c2521c2521c2501c2501c2001c2521c2501c2501d2501d2501c2511c2521b2501a2511825117251
591400001c2501c2501c2501c2411c2501c2501c2501c2531b2551b2551b2551b2501b2451b2551b2521b2521c2521c2521c2501c2501c2531c2521c2501c2501d2501d255242502425329250292503025230250
311400000f200000000000000000000000000000000000001b2001e2001e200222001b2001b2001b2000000000000000000000000000000000000000000000001b2001e20026200222001b200262001b2000f200
19140008138700000000000069001e9501e9431e9331e9231f80000000000001e9001e9001e9001e9001e9001f8001f800000001e9001e9001e9001e900000001f80000000000001e9001e9001e9000000000000
591400002f3502f3412f3312f3312f3312f3202f35037355303403033530320303502f3502b3502b3502b3502f3502f3412f3312f3312f3312f3212f3212f3113335533355333523335234355343503635036350
591400002825028250282502824128250282502825028253272552725527255272402724527255272522725228252282522825028250282532825228250282502925029250282512825229250292502a2512b250
011400002f7602f7502f7422f7422f7322f7322b7502b7502d7502d7502b7502b7502d7502d75030751307552f7502f7502f7502f750047002b7512b750347513475534755337553375530755307552f7552f755
911400003b7603b7503b7423b7423b7323b73237750377503975039750377503775039750397503c750307003b7503b7503b7503b7501c7003975139750347513475534755337553375530765307652f7752f775
491400002f7602f7502f7422f7422f7322f7322b7502b7502d7502d7502b7502b7502d7502d75030750307002f7502f7502f7502f7501c700397002b7502b7502d7502d7502b7502b7502d7502d7522675126752
591400002f3502f3412f3312f3312f3312f3202f35037355303403033530320303502f3502b3502b3502b3502f3502f3412f3312f3312f3312f3212f3212f3113335533355333523335230351303522f3522f352
59140000283352833528335283352833528325283152831527335273352735527355273352735527345273352835528345283452833528335283252831528315273352733527335273552a355273652a36527365
611400001024013242152421724010240132401524017240102400e2400b24007240102550e2500b2520725010240132421524217241122401324215240182401c2411a240172401a240282502b2552825526250
1114000010250102501025010241102501025010250102530f2550f2550f2550f2500f2400f2550f2520f25210252102521025010253102521025210250102501125011250102511025211250112501225113250
791400001c2401f24221242232401c2401f240212402324024240232401f2401d240242551f2501d2521c2501c2401f24221242232411c2401f24221241222412824526245232451f2451b2451b2351b2251b215
611400001c2401f24221242232401c2401f240212402324024240232401f2401d240242551f2501d2521c2501c2401f24221242232411c2401f2422124122241282452d24123241282421f2421f2551f2651f275
1114000010250102501025010240102501025010250102530f25512255122550f2500f2450f2550f2520f2521025210252102501025010200102521025010250112501125010251102520f2500e2510c2510b251
611400001024013242152421724010240132401524017240102400e2400b24007240102550e2500b2520725010240132421524217241102401324215240182401c2411a24017240132401c2501f2551c2551a250
0114000013860198001380018800138600e8001380000000138600000013860000001386000000138600000013860000001380000000138600000000000000001386513865138651386513865138651386513865
0114000013870198001380018800138700e8001380000000138700000013870000001387000000138700000013870000001380000000138700000000000000001387513875138751387513875138751387513875
01140008138700000000000069001e9501e9501e9001e900000001f80000000000001e9001e9001e9001e9001e9001f8001f800000001e9001e9001e9001e900000001f80000000000001e9001e9001e90000000
0114000013860000000f6550f6551e9601e9600f6550f655138600f6550f6550f6551e9501e9500f6550f60013860000000f6550f6551e9601e9600f6550f600138600f6550f6550f6551e9501e9500f6540f655
010a00101463514625146231461514625146231464514665146001460014600146001460014600146001460014635146251462514625146451462514625146251463514625146251463514625146251463414615
2114000010050100401004010030100301002010020100150f0500f0500f0400304003040030300f0500f033100501004010040100301c0301c0211c0111c011100501005010050100500f0550f0550f0550f055
591400003b3503b3413b3313b3313b3313b3203b3503b3552f3403b3353332533350373503734037330373202f3502f3412f3312f33134331343213432134311333553335533352333522a3512a3522735227352
591400001c2501c2501c2501c2411c2501c2501c2501c2531b2551b2551b2551b250222451b2551b2521b2551c2521c2521c2501c2501c2001c2521c2501c2501d2501d2501c2511c25228345283352b3252b315
0114000013870000000f6550f6551e9501e9500f6550f655138700f6550f6550f6551e9501e9500f6551e95013870000000f6550f6551e9501e9500f6550f600138700f6550f6550f6550f6550f6350f6250f615
591400002f3502f3412f3312f3312f3312f3202f35037355303403033530320303502f3502b3502b3502b3502f3502f3412f3312f3312f3312f3212f3212f311333553335533352333522a3502a3522b3522b352
59140000283502834128331283312832128321283112831527355273552735527350273522a355273502735028351283412833128331283212832128311283152735527355273552735527355273552735527353
0114000013870000000f6550f6551e9501e9500f6550f655138700f6550f6550f6551e9501e9500f6550f600138700f655138700f675138701e900138700f6001387013870138701387013870138701387013870
2114000010050100401004010030100301002010020100150f0500f0500f0400304003040030300f0500f033100501004010040100301c0301c0211c0111c0111000010000100001000003000060000300006000
09141000273352733527345273452735527365273752737333351273551b351273550f365273650f3712737300000000000000000000000000000000000000000000000000000000000000000000000000030400
591410000f3350f3350f3450f3450f3550f3650f3750f3730c855003000c865000000c8650c8750c8750c87500000000000000000000000000000000000000000000000000000000000000000000000000000000
010a00002765527645276352765527645276352767527625276552764527635276552764527635276752764527625276552766527645276652764527675276752795327943279332795327923279332795327953
7114100027345273452734527355273552735527365273631b3351b3351c3351e3351f342213451e3521f35500000000000000000000000000000000000000000000000000000000000000000000000000000000
111400001c1401f14221142231401c1401f14021140231401b140211401f1401c140271551f1501e1521b1501c1401f14221142231411c1401f1422114122141281452d14123141281421f1421f1551b1651b175
01140000138600f6750f6750f6751e9601e9600f6750f675138600f6750f6750f6751e9501e9500f6550f600138600f6750f6750f6751e9601e9600f6550f655138600f6750f6750f6751e9501e9500f6740f675
1114000010250102501025010241102501025010250102530f2550f2550f2550f2500f2400f2550f2520f25210252102521025010253102521025210252102520f2500f25512250122550c2500c2550e2500e255
5914000028250282502825028241282502825028250282532725527255272552724027245272552725227252282522825228250282502825328252282522825227250272552a2502a25524250242552625026255
0114000013870000000f6550f6551e9501e9500f6550f655138700f6550f6550f6551e9501e9500f6550f600138700f655138700f675138701e900138700f60023a500fa5523a500fa5523a500fa5023a500fa55
111400001c1401f14221142231401c1401f14021140231401b140211401f1401c140271551f1501e1521b1501c1401f14221142231411c1401f142231412314127315273152a3252a32524335243352633526335
59140000283502834128331283312832128321283112831527355273552a3552a350243522435526350263502835128341283312833128321283212831128315273552735527355273452a3452a3552936529365
2114000010050100401004010030100301002010020100150f0500f0500f0400304003040030300f0500f033100501004010040100301c0301c0211c0111c0110f0550f0550f0650f06512075120751107511075
5914000028355283552834528345283352833528325283152831528315283152831528315283152831527300102551025510255102551025510255102551025510255273002730027300042552a3002930029300
591000001005010040100401003010030100201002010020100201002010015000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
59140000343553435534345343453433534335343253431534315343153431527300273002a30027300273002830028300283002830028300283002830028300273002730027300273002a3002a3002930029300
011000001fa511fa511fa511fa511fa511fa511fa511fa001fa001fa0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
59140000283552835528345283452833528335283252831528315283152831527300273002a30027300273001020010200102001020010200102001020010200102002730027300273002a3002a3002930029300
011400001c0401c03210032100401c040100401c0501c04218041180401804018040180531803218042180421c0401c04010042100421c040100421c0421c0201d0401d0401d0421d0421b0451b0351b0251b015
011400001c0401c04010040100421c042100401c0401c04018040180451804218040180431804218042180421c0401c04010040100401c042100421c0401c0401d0411d0401d0401d0401f0421f0521f0651f075
0914000010770047001075004700107600470010760107730f7550f7000f7550f7000f7400f7550f7720f77210752107001075010700107521070010760107701176011760107611077211770117701277113770
0914000010750047001076004700107700470010760107530f765037000f755037000f7600f7750f7720f77210762047001075004700107420470010760107701175011750107611076211770117701277113770
011400001c0421c0311c0211c0111c0451c0351c0251c0151c0401c0401a0401a040170451704513042130421c0421c0311c0211c0111c0451c0351c0251c0151c0611a06017060130601c0601f0651c0651a060
01140000138600f6750f6750f6751e9601e9600f6750f675138600f6750f6750f6751e9501e9500f6550f600138600f6750f6750f6751e9601e9600f6550f655138600f6000f6000f600138201e9000f6000f600
__music__
01 16177944
00 11173944
00 131a3544
00 141f3644
00 12193844
00 15193744
00 061a3744
00 071a3744
00 070c1a37
00 1e0e1f37
00 101c191b
00 101c191b
00 0f1c1a1b
00 201c1a1b
00 21232226
00 24252627
00 19122844
00 19122844
00 1912280b
00 2c2a2d2b
00 3a1c1b2e
00 342f5b4b
00 30333231

